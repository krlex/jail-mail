---
- name: install packages
  become: yes
  with_items: "{{ dovecot_packages }}"
  apt:
    pkg: "{{ item.name }}"
    state: latest
  notify:
    - restart dovecot

- name: create data dir
  become: yes
  file:
    path: /data
    owner: dovecot
    group: dovecot
    state: directory

- name: configure ldap auth
  become: yes
  template:
    src: dovecot-ldap.conf.ext.j2
    dest: /etc/dovecot/dovecot-ldap.conf.ext
    owner: root
    group: root
    mode: 0600
  notify:
    - restart dovecot

- name: configure dovecot
  become: yes
  with_items: "{{ dovecot_configs }}"
  template:
    src: "{{ item.name }}.j2"
    dest: "/etc/dovecot/conf.d/{{ item.name }}"
    owner: root
    group: root
  notify:
    - restart dovecot

- name: install cert
  become: yes
  with_items: "{{ dovecot_certs }}"
  copy:
    src: "{{ item.name }}"
    dest: "/etc/dovecot/{{ item.name }}"
    owner: root
    group: root
    mode: 0644
  notify:
    - restart dovecot
